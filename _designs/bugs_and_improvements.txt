PEF BUGS, CLEANUP, AND TEST IMPROVEMENTS
=========================================
Date: 2026-01-24
Updated: 2026-01-24

STATUS: Partially completed - see [DONE] markers below


================================================================================
BUGS TO FIX
================================================================================

BUG #1: Variable shadowing in orchestrator.py [DONE]
Location: pef/core/orchestrator.py:202
Severity: Medium

The module-level logger (line 14):
    logger = logging.getLogger(__name__)

Is shadowed inside process() by the BufferedLogger context manager (line 202):
    with BufferedLogger(output_dir) as logger:

This means any calls to logger.debug/info/warning inside the `with` block
would call BufferedLogger.log() instead of the Python logging module.

Fix: Rename the BufferedLogger variable:
    with BufferedLogger(output_dir) as file_logger:
        file_logger.log(...)

FIXED: Renamed to file_logger in orchestrator.py


BUG #2: Potential unhandled exception in checkout_dir [DONE]
Location: pef/core/utils.py:64-68
Severity: Low

When onlynew=False and the path doesn't exist as a directory, os.makedirs()
is called. But if the path exists as a FILE (not directory), os.makedirs()
will raise FileExistsError.

Current code:
    if not os.path.isdir(path) and not onlynew:
        os.makedirs(path)

Fix: Add check for existing file:
    if os.path.isfile(path):
        raise ValueError(f"Cannot create directory: {path} exists as a file")
    if not os.path.isdir(path) and not onlynew:
        os.makedirs(path)

FIXED: Added file existence check with clear error message.
Added test: test_raises_error_if_file_exists


BUG #3: Scanner double-pass performance issue [DONE - ALREADY FIXED]
Location: pef/core/scanner.py:54-57
Severity: Low (performance, not correctness)

The scanner walks the entire directory tree twice - once to count directories
for progress, then again to actually scan. For large directories, this doubles
the I/O time.

ALREADY FIXED: Scanner now uses single-pass _fast_walk() with os.scandir.
Progress updates show "Found N files..." instead of percentage.


================================================================================
CODE CLEANUP
================================================================================

CLEANUP #1: Unused ProcessingResult model
Location: pef/core/models.py:107-113

The ProcessingResult dataclass is defined but never used. The codebase uses
ProcessResult instead (lines 131-142).

Action: Either remove ProcessingResult or consolidate with ProcessResult.


CLEANUP #2: Duplicate code in find_match vs find_match_in_index [DONE]
Location: pef/core/matcher.py:116-186

The find_match() and find_match_in_index() methods are nearly identical.
The only difference is which file_index is used.

Fix: Refactor to use a single method with optional file_index parameter:
    def find_match(self, json_path, title, file_index=None):
        idx = file_index if file_index is not None else self.file_index
        ...

FIXED: find_match() now accepts optional file_index parameter.
find_match_in_index() now just delegates to find_match().


CLEANUP #3: Inconsistent use of Optional type hints
Location: Various files

Some parameters use Optional[X] while others use X = None. Be consistent:
    Good: def foo(x: Optional[str] = None)
    Also good: def foo(x: str | None = None)
    Bad: def foo(x: str = None)  # type checker will complain


================================================================================
TEST IMPROVEMENTS
================================================================================

CURRENT COVERAGE STATUS:
  - test_models.py      : Good coverage
  - test_utils.py       : Good coverage (but missing edge cases)
  - test_scanner.py     : Good coverage
  - test_matcher.py     : Good coverage (missing find_match_in_index)
  - test_metadata.py    : Excellent coverage
  - test_processor.py   : Good coverage
  - test_logger.py      : Good coverage
  - test_exiftool.py    : Good coverage
  - test_orchestrator.py: Good coverage
  - test_cli.py         : Good coverage (heavily mocked)


MISSING TESTS - HIGH PRIORITY:

1. test_matcher.py - find_match_in_index() method not tested [DONE]
   Added:
   - TestFileMatcherFindMatchInIndex class with 3 tests
   - TestMatchResult class with 3 tests for is_matched property

2. test_scanner.py - rescan behavior [DONE]
   Added:
   - test_rescan_clears_previous_results
   - test_rescan_picks_up_new_files
   - test_handles_unicode_filenames

3. test_utils.py - checkout_dir edge cases [DONE]
   Added:
   - test_existing_dir_no_onlynew_returns_same
   - test_onlynew_creates_multiple_unique
   - test_creates_nested_directories

4. test_processor.py - batch processing [DONE]
   Added:
   - TestProcessUnmatchedFiles class with 4 tests
   - TestFileProcessorErrorHandling class with 1 test

5. test_orchestrator.py - error accumulation [DONE]
   Added:
   - TestPEFOrchestratorErrorHandling class with 3 tests


MISSING TESTS - MEDIUM PRIORITY:

6. test_matcher.py - MatchResult.is_matched alias
   Add:
   def test_is_matched_alias(self):
       result = MatchResult(found=True, files=[], json_path="", title="")
       assert result.is_matched is True

       result2 = MatchResult(found=False, files=[], json_path="", title="")
       assert result2.is_matched is False

7. test_exiftool.py - read_tags variations
   Add:
   def test_read_tags_no_tags_specified(self, mock_exiftool_module):
       # Calls get_metadata instead of get_tags

   def test_read_tags_empty_result(self, mock_exiftool_module):
       mock_helper.get_tags.return_value = []
       result = manager.read_tags("/path", ["GPSLatitude"])
       assert result == {}

8. test_orchestrator.py - progress callback details
   Add:
   def test_progress_callback_receives_correct_total(self, sample_takeout):
       calls = []
       def callback(cur, tot, msg):
           calls.append((cur, tot, msg))

       orchestrator.dry_run(on_progress=callback)

       # Verify totals are accurate
       assert calls[-1][0] == calls[-1][1]  # Final: current == total

9. test_scanner.py - special characters in paths
   Add:
   def test_handles_unicode_filenames(self, temp_dir):
       album = os.path.join(temp_dir, "Album")
       os.makedirs(album)

       # Create file with unicode name
       filepath = os.path.join(album, "日本語.jpg")
       with open(filepath, "wb") as f:
           f.write(b"data")

       scanner = FileScanner(temp_dir)
       scanner.scan()

       assert any("日本語" in f.filename for f in scanner.files)


MISSING TESTS - LOW PRIORITY:

10. Integration tests with real file operations
    Add test_integration.py with tests that:
    - Create actual temp directory with real structure
    - Run full dry_run -> process workflow
    - Verify files actually copied
    - Verify dates actually set (without mocking filedate)

11. test_cli.py - less mocking
    Some tests could use the actual orchestrator with mocked exiftool/filedate
    instead of mocking the entire orchestrator.


================================================================================
CONFTEST IMPROVEMENTS
================================================================================

1. Add fixture for long filename scenario:
   @pytest.fixture
   def sample_long_filename(temp_dir):
       album = os.path.join(temp_dir, "Album")
       os.makedirs(album)

       long_name = "a" * 50 + ".jpg"  # 54 chars total
       truncated = "a" * 47 + ".jpg"  # 51 chars

       with open(os.path.join(album, truncated), "wb") as f:
           f.write(b"data")

       json_path = os.path.join(album, f"{long_name}.json")
       with open(json_path, "w") as f:
           json.dump({
               "title": long_name,
               "photoTakenTime": {"timestamp": "1609459200"}
           }, f)

       return temp_dir

2. Add fixture for bracket/duplicate scenario:
   @pytest.fixture
   def sample_duplicates(temp_dir):
       # Similar to old unused fixture, but actually used


================================================================================
TEST QUALITY IMPROVEMENTS
================================================================================

1. Add pytest markers:
   pytest.ini or conftest.py:
   - @pytest.mark.slow for tests that take time
   - @pytest.mark.integration for integration tests
   - @pytest.mark.unit for unit tests

2. Add test coverage reporting:
   pytest --cov=pef --cov-report=html

3. Consider adding:
   - pytest-randomly for test order randomization
   - pytest-timeout for hanging test detection


================================================================================
PRIORITY ORDER FOR FIXES
================================================================================

HIGH PRIORITY (Do first):
1. Fix BUG #1 - variable shadowing (5 min)
2. Add test for find_match_in_index (15 min)
3. Add test for rescan behavior (15 min)
4. Add tests for error accumulation (30 min)

MEDIUM PRIORITY:
5. Fix BUG #2 - checkout_dir file exists (10 min)
6. Add batch processing tests (20 min)
7. Add MatchResult.is_matched test (5 min)
8. Clean up ProcessingResult unused model (5 min)

LOW PRIORITY:
9. Fix BUG #3 - scanner double-pass (30-60 min)
10. Refactor find_match_in_index duplicate code (15 min)
11. Add integration tests (1-2 hours)
12. Add conftest fixtures for edge cases (20 min)


================================================================================
END OF DOCUMENT
================================================================================
